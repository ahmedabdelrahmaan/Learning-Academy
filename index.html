<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Learning Platform</title>
    <!-- Tailwind CSS for modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles and dark mode variables */
        :root { --bg-light: #f8fafc; --text-dark: #1f2937; --card-bg-light: #ffffff; }
        .dark { --bg-light: #111827; --text-dark: #f3f4f6; --card-bg-light: #1f2937; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            transition: background-color 0.3s, color 0.3s; 
        }
        .card { 
            background-color: var(--card-bg-light); 
            transition: background-color 0.3s; 
        }
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; 
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div>
    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8"></div>
    <div id="modal-container" class="hidden"></div>

    <script type="module">
        // --- 1. FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, 
            serverTimestamp, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. CONFIGURATION AND STATE ---
        const APP_STATE = {
            db: null, auth: null, userId: null, userProfile: null,
            currentPage: 'home', pageParams: {}, isAuthReady: false,
            isDarkMode: localStorage.getItem('darkMode') === 'true',
            dataCache: { courses: [], subscriptions: [], progress: new Set() }
        };

        const ENV = {
            // User-provided Firebase Config (Example values are kept here)
            firebaseConfig: {
                apiKey: "AIzaSyAjPzI2w1ptXjfF-nANHTg57zqfznOyVo",
                authDomain: "daring-runway-406008.firebaseapp.com",
                projectId: "daring-runway-406008",
                storageBucket: "daring-runway-406008.firebasestorage.app",
                messagingSenderId: "233176620103",
                appId: "1:233176620103:web:643129a90e6a74f9e8e562",
                measurementId: "G-ERF6KJT723"
            },
            // User-provided IMGBB Key (Example value is kept here)
            IMGBB_API_KEY: '994244fa58d67f7d0f05ed58d03e7962',
            // Environment variables provided by Canvas
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null
        };
        
        const COLLECTIONS = {
            USERS: `artifacts/${ENV.appId}/users`,
            PUBLIC_DATA: `artifacts/${ENV.appId}/public/data`
        };

        // --- 3. UTILITIES ---
        const Utils = {
            snapshotToData: (snapshot) => {
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            },

            showToast: (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const colorMap = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                const toast = document.createElement('div');
                toast.className = `p-4 rounded-lg shadow-xl text-white ${colorMap[type] || 'bg-gray-700'} transition-all duration-300 transform translate-x-full opacity-0`;
                toast.textContent = message;

                container.appendChild(toast);
                setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 10);
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 5000);
            },

            openModal: (contentHTML) => {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = contentHTML;
                modalContainer.classList.remove('hidden');
                lucide.createIcons();
            },

            closeModal: () => {
                document.getElementById('modal-container').classList.add('hidden');
            },

            toggleDarkMode: () => {
                APP_STATE.isDarkMode = !APP_STATE.isDarkMode;
                document.documentElement.classList.toggle('dark', APP_STATE.isDarkMode);
                localStorage.setItem('darkMode', APP_STATE.isDarkMode);
                Router.renderApp(); 
            }
        };

        // EXPOSE UTILITIES TO GLOBAL SCOPE
        window.showToast = Utils.showToast;
        window.closeModal = Utils.closeModal;
        window.toggleDarkMode = Utils.toggleDarkMode;

        // --- 4. SERVICES (Firebase & IMGBB) ---
        const Service = {
            /** Initializes Firebase and sets up authentication. */
            init: async () => {
                try {
                    // Check for global variables and configure Firebase
                    const firebaseConfig = typeof __firebase_config !== 'undefined' 
                        ? JSON.parse(__firebase_config) 
                        : ENV.firebaseConfig;

                    const app = initializeApp(firebaseConfig);
                    APP_STATE.db = getFirestore(app);
                    APP_STATE.auth = getAuth(app);
                    
                    document.documentElement.classList.toggle('dark', APP_STATE.isDarkMode);

                    const authPromise = ENV.initialAuthToken 
                        ? signInWithCustomToken(APP_STATE.auth, ENV.initialAuthToken) 
                        : signInAnonymously(APP_STATE.auth);
                    await authPromise;
                    
                    onAuthStateChanged(APP_STATE.auth, (user) => {
                        if (user) {
                            APP_STATE.userId = user.uid;
                            Service.setupListeners(user.uid);
                        } else {
                            APP_STATE.userId = null;
                            APP_STATE.userProfile = null;
                            APP_STATE.isAuthReady = true;
                            Router.navigateTo('home');
                        }
                        APP_STATE.isAuthReady = true;
                        Router.renderApp();
                    });
                } catch (error) {
                    console.error("Error initializing Firebase/Auth:", error);
                    Utils.showToast("Could not initialize the app. Check console.", 'error');
                    APP_STATE.isAuthReady = true;
                    Router.renderApp();
                }
            },

            /** Sets up real-time listeners for the authenticated user's data. */
            setupListeners: (userId) => {
                const { db, dataCache } = APP_STATE;

                // 1. User Profile Listener
                const userDocRef = doc(db, COLLECTIONS.PUBLIC_DATA, 'users', userId);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        APP_STATE.userProfile = { id: userId, ...docSnap.data() };
                        Router.renderApp();
                    } else {
                        const newProfile = { 
                            displayName: APP_STATE.auth.currentUser?.email || `User ${userId.substring(0, 5)}`,
                            email: APP_STATE.auth.currentUser?.email || null,
                            isTutor: false,
                            joinedAt: serverTimestamp()
                        };
                        setDoc(userDocRef, newProfile).then(() => {
                            APP_STATE.userProfile = { id: userId, ...newProfile };
                            Utils.showToast('Welcome! Your profile has been created.', 'info');
                            Router.renderApp();
                        }).catch(e => console.error("Error creating profile:", e));
                    }
                });

                // 2. Courses Listener (Public data)
                const coursesQuery = query(collection(db, COLLECTIONS.PUBLIC_DATA, 'courses'));
                onSnapshot(coursesQuery, (snapshot) => {
                    APP_STATE.dataCache.courses = Utils.snapshotToData(snapshot);
                    Router.renderApp();
                });

                // 3. Subscriptions Listener (Public data - for tutors to review)
                const subscriptionsQuery = query(collection(db, COLLECTIONS.PUBLIC_DATA, 'subscriptions'));
                onSnapshot(subscriptionsQuery, (snapshot) => {
                    APP_STATE.dataCache.subscriptions = Utils.snapshotToData(snapshot);
                    Router.renderApp();
                });

                // 4. Progress Listener (Private data)
                const progressQuery = query(collection(db, COLLECTIONS.USERS, userId, 'progress'));
                onSnapshot(progressQuery, (snapshot) => {
                    APP_STATE.dataCache.progress = new Set(Utils.snapshotToData(snapshot).map(p => p.id));
                    Router.renderApp();
                });
            },

            /** Uploads a file to IMGBB and returns the URL. */
            uploadImageToImgBB: async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Image = reader.result.split(',')[1];
                        
                        const formData = new FormData();
                        formData.append("image", base64Image);

                        const apiUrl = `https://api.imgbb.com/1/upload?key=${ENV.IMGBB_API_KEY}`;
                        
                        try {
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                body: formData,
                            });
                            
                            if (!response.ok) {
                                throw new Error(`IMGBB API returned status: ${response.status}`);
                            }

                            const result = await response.json();
                            
                            if (result.success && result.data && result.data.url) {
                                resolve(result.data.url);
                            } else {
                                throw new Error(result.error?.message || 'IMGBB upload failed with no specific error.');
                            }

                        } catch (error) {
                            console.error("IMGBB Upload Error:", error);
                            Utils.showToast('Image upload failed. Check API key or file type.', 'error');
                            reject(error);
                        }
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });
            },

            /** Global sign out function. */
            signOutUser: async () => {
                try {
                    await signOut(APP_STATE.auth);
                    Utils.showToast('Signed out successfully!', 'info');
                } catch (error) {
                    console.error("Sign out error:", error);
                    Utils.showToast('Failed to sign out.', 'error');
                }
            },
        };

        // EXPOSE SERVICE FUNCTIONS TO GLOBAL SCOPE
        window.signOutUser = Service.signOutUser;

        // --- 5. COMPONENTS (UI Rendering) ---
        const UI = {
            renderLoadingScreen: (message) => `
                <div class="flex items-center justify-center p-16 text-gray-500 dark:text-gray-400">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `,

            renderNotFound: () => `
                <div class="text-center py-20">
                    <h2 class="text-4xl font-bold text-red-600 dark:text-red-400">404 - Page Not Found</h2>
                    <p class="mt-4 text-lg dark:text-gray-300">The requested page does not exist.</p>
                    <button onclick="navigateTo('dashboard')" class="mt-6 bg-indigo-600 text-white px-6 py-2 rounded-lg shadow hover:bg-indigo-700 transition">Go to Dashboard</button>
                </div>
            `,

            renderHeader: () => {
                const { userProfile, isDarkMode } = APP_STATE;
                const userName = userProfile ? userProfile.displayName : 'Guest';
                const profileSnippet = userProfile ? `
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium hidden sm:inline truncate max-w-[100px]">${userName}</span>
                        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-bold text-sm">${userName[0]}</div>
                    </div>
                ` : `
                    <span class="text-sm font-medium">Please wait...</span>
                `;

                return `
                    <header class="card p-4 rounded-xl shadow-lg flex justify-between items-center sticky top-0 z-40 mb-4">
                        <div class="flex items-center space-x-6">
                            <!-- Corrected: Router.navigateTo -> navigateTo -->
                            <h1 onclick="navigateTo('dashboard')" class="text-xl font-extrabold text-indigo-600 cursor-pointer hover:text-indigo-800 transition">
                                <span class="hidden sm:inline">IntelliLearn</span>
                                <span class="sm:hidden">ILP</span>
                            </h1>
                            <nav class="hidden md:flex space-x-4">
                                <button onclick="navigateTo('dashboard')" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition">Dashboard</button>
                                <button onclick="navigateTo('catalog')" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition">Catalog</button>
                                ${userProfile?.isTutor ? `
                                    <button onclick="navigateTo('add-course')" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition">Add Course</button>
                                    <button onclick="navigateTo('manage-subscriptions')" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition">Manage Subs</button>
                                ` : ''}
                            </nav>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${profileSnippet}
                            <!-- Corrected: Utils.toggleDarkMode -> toggleDarkMode -->
                            <button onclick="toggleDarkMode()" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition" aria-label="Toggle Dark Mode">
                                ${isDarkMode ? '<i data-lucide="sun" class="w-5 h-5"></i>' : '<i data-lucide="moon" class="w-5 h-5"></i>'}
                            </button>
                            <!-- Corrected: Service.signOutUser -> signOutUser -->
                            <button onclick="signOutUser()" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition" aria-label="Sign Out">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </header>
                `;
            },
            
            renderCourseCard: (course, isEnrolled = false) => `
                <div class="card p-5 rounded-xl shadow-lg flex flex-col justify-between hover:shadow-xl transition">
                    <div>
                        <h3 class="text-xl font-semibold text-indigo-600">${course.title}</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-1 mb-3">${course.description.substring(0, 100)}${course.description.length > 100 ? '...' : ''}</p>
                        <p class="text-sm font-medium mb-3">Tutor: ${course.tutorName || 'N/A'}</p>
                    </div>
                    <div class="flex justify-between items-center mt-auto pt-3 border-t border-gray-100 dark:border-gray-700">
                        <span class="text-lg font-bold text-green-600">$${course.price.toFixed(2)}</span>
                        <!-- Corrected: Router.navigateTo -> navigateTo -->
                        <button onclick="navigateTo('course-details', { courseId: '${course.id}' })" 
                                class="bg-indigo-500 text-white px-4 py-1.5 rounded-lg text-sm shadow hover:bg-indigo-600 transition">
                            ${isEnrolled ? 'View Course' : 'Details'}
                        </button>
                    </div>
                </div>
            `,

            renderDashboard: async () => {
                const { userProfile, dataCache } = APP_STATE;
                const courses = dataCache.courses;

                const mySubscriptions = dataCache.subscriptions.filter(sub => 
                    sub.userId === userProfile.id && sub.status === 'approved'
                );
                
                const enrolledCourseIds = new Set(mySubscriptions.map(sub => sub.courseId));
                const enrolledCourses = courses.filter(c => enrolledCourseIds.has(c.id));
                const createdCourses = courses.filter(c => c.tutorId === userProfile.id);

                return `
                    <section class="space-y-10">
                        <div class="p-6 rounded-xl bg-indigo-50 dark:bg-gray-800 shadow-inner">
                            <h2 class="text-3xl font-bold text-indigo-700 dark:text-indigo-400">Welcome back, ${userProfile.displayName}!</h2>
                            <p class="mt-2 text-indigo-600 dark:text-indigo-300">Your User ID: <span class="font-mono text-xs p-1 bg-indigo-200 dark:bg-gray-700 rounded">${userProfile.id}</span></p>
                            ${userProfile.isTutor ? '<p class="mt-1 text-lg font-semibold text-teal-600 dark:text-teal-400">You are registered as a Tutor.</p>' : ''}
                        </div>

                        ${enrolledCourses.length > 0 ? `
                            <div class="space-y-4">
                                <h3 class="text-2xl font-semibold border-b pb-2 text-gray-800 dark:text-gray-200">My Enrolled Courses</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${enrolledCourses.map(c => UI.renderCourseCard(c, true)).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="text-center p-10 card rounded-xl shadow">
                                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">You are not currently enrolled in any courses.</h3>
                                <p class="mt-2 text-gray-500">Explore the <a href="#" onclick="navigateTo('catalog')" class="text-indigo-600 hover:underline">Catalog</a> to find your next lesson!</p>
                            </div>
                        `}

                        ${userProfile.isTutor && createdCourses.length > 0 ? `
                            <div class="space-y-4">
                                <h3 class="text-2xl font-semibold border-b pb-2 text-gray-800 dark:text-gray-200">My Created Courses</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${createdCourses.map(c => UI.renderCourseCard(c)).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </section>
                `;
            },
            
            renderCourseCatalog: async () => {
                const { dataCache } = APP_STATE;
                const courses = dataCache.courses;

                return `
                    <section class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 border-b pb-3">Course Catalog</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${courses.length > 0 ? courses.map(UI.renderCourseCard).join('') : UI.renderLoadingScreen('No courses found or still loading...')}
                        </div>
                    </section>
                `;
            },

            renderCourseDetails: (courseId) => {
                const { dataCache, userProfile } = APP_STATE;
                const course = dataCache.courses.find(c => c.id === courseId);

                if (!course) return UI.renderNotFound();

                const subscription = dataCache.subscriptions.find(sub => 
                    sub.userId === userProfile.id && sub.courseId === courseId
                );
                
                const isApproved = subscription?.status === 'approved';
                const isUnderReview = subscription?.status === 'underReview';
                const isCreator = course.tutorId === userProfile.id;
                
                let statusText = '';
                if (isCreator) {
                    statusText = '<span class="bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-300 px-3 py-1 rounded-full text-sm font-medium">Course Creator</span>';
                } else if (isApproved) {
                    statusText = '<span class="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 px-3 py-1 rounded-full text-sm font-medium">Enrolled (Approved)</span>';
                } else if (isUnderReview) {
                    statusText = `<span class="bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300 px-3 py-1 rounded-full text-sm font-medium">Subscription Under Review</span>`;
                } else if (course.price > 0) {
                    // Corrected: UI.openSubscriptionModal -> openSubscriptionModal
                    statusText = `<button onclick="openSubscriptionModal('${course.id}')" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-green-700 transition font-semibold">Subscribe for $${course.price.toFixed(2)}</button>`;
                } else {
                    statusText = '<span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-3 py-1 rounded-full text-sm font-medium">Paid Course</span>';
                }

                // Lesson list rendering
                const renderLessons = () => {
                    if (!isApproved && !isCreator) {
                        return `
                            <p class="text-lg text-red-500 dark:text-red-400 p-4 border border-red-300 rounded-lg bg-red-50 dark:bg-red-900/50">
                                Please complete your subscription to access lesson content.
                            </p>
                        `;
                    }

                    return course.lessons.map((lesson, index) => {
                        const lessonId = `${index}`;
                        const lessonDocId = `${courseId}-${lessonId}`;
                        const isDone = dataCache.progress.has(lessonDocId);
                        const statusIcon = isDone 
                            ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>' 
                            : '<i data-lucide="circle" class="w-5 h-5 text-gray-400"></i>';
                        
                        const actionButton = !isDone 
                            // Corrected: Action.markLessonAsDone -> markLessonAsDone
                            ? `<button onclick="markLessonAsDone('${lessonId}', '${courseId}')" class="text-indigo-600 hover:text-indigo-800 transition text-sm font-medium">Mark as Done</button>`
                            : `<span class="text-green-600 text-sm font-medium">Completed</span>`;

                        return `
                            <li class="flex items-center justify-between p-4 card rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                                <div class="flex items-center space-x-3">
                                    ${statusIcon}
                                    <span class="font-medium dark:text-gray-100">Lesson ${index + 1}: ${lesson}</span>
                                </div>
                                ${actionButton}
                            </li>
                        `;
                    }).join('');
                };

                return `
                    <section class="space-y-6">
                        <div class="card p-6 rounded-xl shadow-lg">
                            <!-- Corrected: Router.navigateTo -> navigateTo -->
                            <button onclick="navigateTo('catalog')" class="text-indigo-600 hover:text-indigo-800 mb-4 flex items-center transition">
                                <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> Back to Catalog
                            </button>
                            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">${course.title}</h2>
                            <div class="flex flex-wrap items-center space-x-4 mt-2 mb-4">
                                ${statusText}
                                <span class="text-gray-500 dark:text-gray-400 text-sm">Duration: ${course.duration}</span>
                                <span class="text-gray-500 dark:text-gray-400 text-sm">Tutor: ${course.tutorName || 'N/A'}</span>
                            </div>
                            <p class="text-lg text-gray-600 dark:text-gray-300 mt-4">${course.description}</p>
                        </div>

                        <div class="card p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-semibold border-b pb-3 mb-4 text-gray-800 dark:text-gray-200">Course Curriculum (${course.lessons.length} Lessons)</h3>
                            <ul class="space-y-3">
                                ${renderLessons()}
                            </ul>
                        </div>
                    </section>
                `;
            },
            
            renderAddCourseForm: () => `
                <section class="max-w-3xl mx-auto card p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-indigo-600 mb-6">Create New Course</h2>
                    <!-- Corrected: Action.handleCourseSubmission -> handleCourseSubmission -->
                    <form onsubmit="handleCourseSubmission(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="title" class="block text-sm font-medium dark:text-gray-300">Course Title</label>
                                <input type="text" id="title" name="title" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium dark:text-gray-300">Description</label>
                                <textarea id="description" name="description" rows="4" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="price" class="block text-sm font-medium dark:text-gray-300">Price ($)</label>
                                    <input type="number" id="price" name="price" min="0" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="duration" class="block text-sm font-medium dark:text-gray-300">Duration (e.g., 4 weeks)</label>
                                    <input type="text" id="duration" name="duration" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div>
                                <label for="lessons" class="block text-sm font-medium dark:text-gray-300">Lessons (One per line)</label>
                                <textarea id="lessons" name="lessons" rows="6" placeholder="Lesson 1: Introduction to X&#10;Lesson 2: Core Concepts&#10;Lesson 3: Project Workshop" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50">
                            Add Course
                        </button>
                    </form>
                </section>
            `,

            renderSubscriptionManagement: async () => {
                const { dataCache, userProfile } = APP_STATE;
                const subscriptions = dataCache.subscriptions;
                const myCourses = dataCache.courses.filter(c => c.tutorId === userProfile.id).map(c => c.id);
                
                const relevantSubscriptions = subscriptions.filter(sub => myCourses.includes(sub.courseId));
                const courseMap = new Map(dataCache.courses.map(c => [c.id, c.title]));
                
                const groupedSubs = relevantSubscriptions.reduce((acc, sub) => {
                    acc[sub.status] = acc[sub.status] || [];
                    acc[sub.status].push(sub);
                    return acc;
                }, {});

                const renderSubscriptionRow = (sub) => {
                    const isUnderReview = sub.status === 'underReview';
                    return `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                            <td class="p-3 text-sm font-medium text-gray-900 dark:text-gray-100 truncate max-w-[150px]">${sub.userName}</td>
                            <td class="p-3 text-sm text-gray-700 dark:text-gray-300">${courseMap.get(sub.courseId) || 'N/A'}</td>
                            <td class="p-3 text-sm text-green-600 font-bold">$${sub.price.toFixed(2)}</td>
                            <td class="p-3 text-sm">
                                <a href="${sub.paymentProofUrl}" target="_blank" class="text-indigo-600 hover:underline flex items-center">
                                    <i data-lucide="image" class="w-4 h-4 mr-1"></i> View Proof
                                </a>
                            </td>
                            <td class="p-3 text-sm">
                                ${sub.reviewerRemark ? `<span class="italic text-gray-500 dark:text-gray-400">${sub.reviewerRemark}</span>` : 'N/A'}
                            </td>
                            <td class="p-3 text-sm">
                                ${isUnderReview ? `
                                    <div class="flex space-x-2">
                                        <!-- Corrected: Action.updateSubscriptionStatus -> updateSubscriptionStatus -->
                                        <button onclick="updateSubscriptionStatus('${sub.id}', true)" 
                                                class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-green-600 transition">Approve</button>
                                        <!-- Corrected: Action.updateSubscriptionStatus -> updateSubscriptionStatus -->
                                        <button onclick="updateSubscriptionStatus('${sub.id}', false)" 
                                                class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-600 transition">Reject</button>
                                    </div>
                                ` : `<span class="capitalize text-${sub.status === 'approved' ? 'green' : 'red'}-600 font-medium">${sub.status}</span>`}
                            </td>
                        </tr>
                    `;
                };

                const renderSubscriptionTable = (title, subs) => `
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">${title} (${subs.length})</h3>
                        <div class="overflow-x-auto card rounded-lg shadow-lg">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Student Name</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Course</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Price</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Payment Proof</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Remark</th>
                                        <th class="p-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                    ${subs.map(renderSubscriptionRow).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;


                return `
                    <section class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 border-b pb-3">Subscription Management</h2>
                        
                        ${relevantSubscriptions.length === 0 ? `
                            <div class="text-center p-10 card rounded-xl shadow">
                                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">No subscription requests for your courses.</h3>
                            </div>
                        ` : ''}

                        ${groupedSubs.underReview && groupedSubs.underReview.length > 0 ? renderSubscriptionTable('New Requests (Under Review)', groupedSubs.underReview) : ''}
                        ${groupedSubs.approved && groupedSubs.approved.length > 0 ? renderSubscriptionTable('Approved Subscriptions', groupedSubs.approved) : ''}
                        ${groupedSubs.rejected && groupedSubs.rejected.length > 0 ? renderSubscriptionTable('Rejected Subscriptions', groupedSubs.rejected) : ''}
                    </section>
                `;
            },
            
            openSubscriptionModal: (courseId) => {
                const course = APP_STATE.dataCache.courses.find(c => c.id === courseId);
                if (!course) return Utils.showToast('Course not found.', 'error');

                const contentHTML = `
                    <!-- Corrected: Utils.closeModal -> closeModal -->
                    <div class="modal-backdrop" onclick="closeModal()">
                        <div class="card p-8 rounded-xl w-full max-w-md mx-4 shadow-2xl" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-start mb-4 border-b pb-3 dark:border-gray-700">
                                <h3 class="text-2xl font-bold text-indigo-600">Subscribe to: ${course.title}</h3>
                                <!-- Corrected: Utils.closeModal -> closeModal -->
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <p class="mb-4 text-gray-600 dark:text-gray-300">Total Price: <span class="text-green-600 font-bold text-xl">$${course.price.toFixed(2)}</span></p>

                            <!-- Corrected: Action.handleSubscriptionRequest -> handleSubscriptionRequest -->
                            <form onsubmit="handleSubscriptionRequest(event)" 
                                data-course-id="${course.id}" 
                                data-tutor-id="${course.tutorId}"
                                data-price="${course.price}"
                                data-duration="${course.duration}">
                                
                                <div class="space-y-4">
                                    <div>
                                        <label for="paymentId" class="block text-sm font-medium dark:text-gray-300">Your Payment/Transaction ID</label>
                                        <input type="text" id="paymentId" name="paymentId" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label for="paymentProof" class="block text-sm font-medium dark:text-gray-300">Upload Payment Proof (Image)</label>
                                        <input type="file" id="paymentProof" name="paymentProof" accept="image/*" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                </div>

                                <button type="submit" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50">
                                    <span id="btn-text">Submit Subscription Request</span>
                                    <span id="spinner" class="hidden animate-spin h-5 w-5 mr-3" role="status">⚙️</span>
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                Utils.openModal(contentHTML);
            }
        };

        // EXPOSE UI FUNCTIONS TO GLOBAL SCOPE
        window.openSubscriptionModal = UI.openSubscriptionModal;

        // --- 6. ACTIONS (Event Handlers) ---
        const Action = {
            /** Handles the course submission (for Tutors). */
            handleCourseSubmission: async (event) => {
                event.preventDefault();
                const { db, userProfile } = APP_STATE;

                if (!userProfile?.isTutor) { Utils.showToast('Permission denied to add course.', 'error'); return; }

                const form = event.target;
                const courseData = {
                    title: form.title.value, description: form.description.value,
                    price: parseFloat(form.price.value) || 0, duration: form.duration.value,
                    tutorId: userProfile.id, tutorName: userProfile.displayName,
                    lessons: (form.lessons.value || '').split('\n').map(l => l.trim()).filter(l => l),
                    createdAt: serverTimestamp()
                };

                const button = form.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="animate-spin mr-2">⚙️</span> Adding...';

                try {
                    await addDoc(collection(db, COLLECTIONS.PUBLIC_DATA, 'courses'), courseData);
                    Utils.showToast('Course added successfully!', 'success');
                    Router.navigateTo('catalog');
                } catch (error) {
                    console.error('Error adding course:', error);
                    Utils.showToast('Failed to add course. See console.', 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            },

            /** Handles the subscription request submission, uses IMGBB for image upload. */
            handleSubscriptionRequest: async (event) => {
                event.preventDefault();
                const { db, userProfile } = APP_STATE;

                if (!userProfile) { Utils.showToast('Please sign in to subscribe.', 'error'); return; }

                const form = event.target;
                const { courseId, tutorId, price, duration } = form.dataset;
                const paymentId = form.paymentId.value;
                const paymentProofFile = form.paymentProof.files[0];

                if (!paymentProofFile) { Utils.showToast('Please upload a payment proof image.', 'error'); return; }

                const button = form.querySelector('button[type="submit"]');
                const btnText = button.querySelector('#btn-text');
                const spinner = button.querySelector('#spinner');
                btnText.classList.add('hidden'); spinner.classList.remove('hidden'); button.disabled = true;

                try {
                    // 1. Upload payment proof image to IMGBB
                    Utils.showToast('Uploading payment proof...', 'info');
                    const paymentProofUrl = await Service.uploadImageToImgBB(paymentProofFile);

                    if (!paymentProofUrl) {
                        throw new Error("Image upload failed to provide a URL.");
                    }

                    // 2. Create subscription request document
                    const subscriptionData = {
                        userId: userProfile.id, userName: userProfile.displayName, userEmail: userProfile.email,
                        courseId, tutorId, price: parseFloat(price), paymentId, duration, paymentProofUrl,
                        status: 'underReview', subscriptionDate: serverTimestamp(), reviewerRemark: ''
                    };
                    await addDoc(collection(db, COLLECTIONS.PUBLIC_DATA, 'subscriptions'), subscriptionData);
                    
                    Utils.showToast('Subscription request sent successfully! Awaiting tutor review.', 'success');
                    Utils.closeModal();
                    Router.navigateTo('dashboard');
                } catch (error) {
                    if (!error.message.includes('IMGBB')) {
                        console.error('Subscription error:', error);
                        Utils.showToast('Failed to send subscription request.', 'error');
                    }
                } finally {
                    btnText.classList.remove('hidden'); spinner.classList.add('hidden'); button.disabled = false;
                }
            },

            /** Marks a lesson as done for the current user. */
            markLessonAsDone: async (lessonId, courseId) => {
                const { db, userId } = APP_STATE;
                if (!userId) { Utils.showToast('You must be signed in.', 'error'); return; }

                const lessonDocId = `${courseId}-${lessonId}`;
                const progressRef = doc(db, COLLECTIONS.USERS, userId, 'progress', lessonDocId);

                try {
                    await setDoc(progressRef, {
                        finished: true, finishedAt: serverTimestamp(), courseId: courseId, lessonIndex: parseInt(lessonId), id: lessonDocId
                    });
                    Utils.showToast('Lesson marked as completed!', 'success');
                } catch (error) {
                    console.error("Error marking lesson done:", error);
                    Utils.showToast('Failed to update progress.', 'error');
                }
            },

            /** Approves or rejects a subscription request (for Tutors). */
            updateSubscriptionStatus: async (subscriptionId, approve) => {
                const { db, userProfile } = APP_STATE;
                if (!userProfile?.isTutor) return Utils.showToast('Permission denied.', 'error');

                const status = approve ? 'approved' : 'rejected';
                // NOTE: Using prompt for simple data gathering, as per constraints.
                const remark = prompt(`Enter a brief remark for the ${status} status:`); 
                if (remark === null) return; 

                const subRef = doc(db, COLLECTIONS.PUBLIC_DATA, 'subscriptions', subscriptionId);
                
                try {
                    await updateDoc(subRef, {
                        status: status, reviewerRemark: remark, reviewDate: serverTimestamp()
                    });
                    Utils.showToast(`Subscription ${status} successfully!`, 'success');
                } catch (error) {
                    console.error(`Error updating subscription:`, error);
                    Utils.showToast(`Failed to update subscription status.`, 'error');
                }
            }
        };

        // EXPOSE ACTION FUNCTIONS TO GLOBAL SCOPE
        window.handleCourseSubmission = Action.handleCourseSubmission;
        window.handleSubscriptionRequest = Action.handleSubscriptionRequest;
        window.updateSubscriptionStatus = Action.updateSubscriptionStatus;
        window.markLessonAsDone = Action.markLessonAsDone;

        // --- 7. ROUTER ---
        const Router = {
            /** Updates the application state and triggers a re-render. Exposed globally. */
            navigateTo: (page, params = {}) => {
                APP_STATE.currentPage = page;
                APP_STATE.pageParams = params;
                history.pushState({ page, params }, '', `#${page}`);
                Router.renderApp();
            },

            /** Handles browser back/forward navigation. */
            onPopState: (event) => {
                if (event.state) {
                    APP_STATE.currentPage = event.state.page || 'dashboard';
                    APP_STATE.pageParams = event.state.params || {};
                }
                Router.renderApp();
            },

            /** The main render function that coordinates UI updates. */
            renderApp: async () => {
                const appContainer = document.getElementById('app-container');
                
                // 1. Always render the Header/Nav first
                appContainer.innerHTML = UI.renderHeader();
                const mainContent = document.createElement('main');
                mainContent.id = 'main-content-area';
                mainContent.className = 'mt-6';
                appContainer.appendChild(mainContent);

                if (!APP_STATE.isAuthReady || !APP_STATE.userProfile) {
                    mainContent.innerHTML = UI.renderLoadingScreen('Initializing application...');
                    return;
                }

                // 2. Render the current page content
                const { currentPage, userProfile } = APP_STATE;
                switch (currentPage) {
                    case 'home':
                    case 'dashboard':
                        mainContent.innerHTML = await UI.renderDashboard();
                        break;
                    case 'catalog':
                        mainContent.innerHTML = await UI.renderCourseCatalog();
                        break;
                    case 'course-details':
                        mainContent.innerHTML = UI.renderCourseDetails(APP_STATE.pageParams.courseId);
                        break;
                    case 'add-course':
                        mainContent.innerHTML = userProfile.isTutor ? UI.renderAddCourseForm() : UI.renderNotFound();
                        break;
                    case 'manage-subscriptions':
                        mainContent.innerHTML = userProfile.isTutor ? await UI.renderSubscriptionManagement() : UI.renderNotFound();
                        break;
                    default:
                        mainContent.innerHTML = UI.renderNotFound();
                }
                
                // 3. Re-render icons after content is loaded
                lucide.createIcons();
            }
        };

        // EXPOSE ROUTER FUNCTIONS TO GLOBAL SCOPE
        window.navigateTo = Router.navigateTo;
        window.onpopstate = Router.onPopState;

        // --- 8. MAIN ENTRY POINT ---
        Service.init();

    </script>
</body>
</html>
