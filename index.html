<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Learning Platform</title>
    <!-- Tailwind CSS for modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
        }
        /* Custom styles for a better UX */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
            max-width: 95%;
            width: 500px;
        }
        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
        /* Protection for video content */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Prevent context menu on video to deter inspection */
        .protected-video-wrapper {
            position: relative;
        }
        .protected-video-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: default;
        }
    </style>
</head>
<body class="min-h-screen antialiased text-gray-800">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- App content will be dynamically rendered here -->
    </div>

    <!-- Modal container for popups like role selection -->
    <div id="modal-container"></div>

    <script type="module">
        // --- Firebase and Library Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot,
            updateDoc, addDoc, serverTimestamp, orderBy, getDocs, deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Environment & API Configuration ---
        const SUPER_ADMIN_EMAIL = "ahmed.abdelrahmany2018@gmail.com";
        const IMGBB_API_KEY = "994244fa58d67f7d0f05ed58d03e7962";
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAjPzI2w1ptxXjfF-nANHTg57zqfznOyVo",
            authDomain: "daring-runway-406008.firebaseapp.com",
            projectId: "daring-runway-406008",
            storageBucket: "daring-runway-406008.appspot.com",
            messagingSenderId: "233176620103",
            appId: "1:233176620103:web:643129a90e6a74f9e8e562",
            measurementId: "G-ERF6KJT723"
        };

        // --- Application State Management ---
        let app, db, auth;
        let currentUser = null; // Holds user auth object
        let userProfile = null; // Holds user data from Firestore `users` collection
        let isAuthReady = false;
        let activeListeners = []; // To manage and clean up Firestore listeners
        
        // State for routing and data
        let currentView = 'loading'; // loading, login, dashboard, tutors, course, admin
        let viewParams = {}; // To pass IDs, e.g., { courseId: '...' }

        // In-memory data stores (cache)
        let allTutors = [];
        let allCourses = [];
        let currentCourseLessons = [];
        let mySubscriptions = [];
        let allSubscriptions = []; // For admins
        let myProgress = []; // For students

        const appContainer = document.getElementById('app');

        // --- Helper Functions (UI, API, etc.) ---

        const showToast = (message, type = 'info') => {
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500',
            };
            const toastId = `toast-${Date.now()}`;
            const toastElement = document.createElement('div');
            toastElement.id = toastId;
            toastElement.className = `fixed top-5 right-5 ${colors[type]} text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
            toastElement.textContent = message;
            
            document.body.appendChild(toastElement);

            setTimeout(() => {
                toastElement.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                toastElement.classList.add('translate-x-full');
                toastElement.addEventListener('transitionend', () => toastElement.remove());
            }, 3000);
        };
        
        const navigateTo = (view, params = {}) => {
            currentView = view;
            viewParams = params;
            renderApp();
            window.scrollTo(0, 0); // Scroll to top on navigation
        };

        const uploadToImgBB = async (file) => {
            const formData = new FormData();
            formData.append('image', file);
            const url = `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`;
            
            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error(result.error.message || 'Unknown error uploading image.');
                }
            } catch (error) {
                console.error('ImgBB Upload Error:', error);
                showToast('Failed to upload payment proof.', 'error');
                return null;
            }
        };

        // --- Firebase Core Logic ---

        const initializeAppAndAuth = () => {
            app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                // Clean up previous listeners to prevent memory leaks
                activeListeners.forEach(unsubscribe => unsubscribe());
                activeListeners = [];

                if (user) {
                    currentUser = user;
                    await fetchUserProfile(user); // Fetches or creates user profile
                    setupDataListeners();
                    navigateTo('dashboard');
                } else {
                    currentUser = null;
                    userProfile = null;
                    isAuthReady = true;
                    navigateTo('login');
                }
            });
        };

        const fetchUserProfile = async (user) => {
            const userRef = doc(db, 'users', user.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                userProfile = { id: docSnap.id, ...docSnap.data() };
            } else {
                // New user: Show role selection modal
                const role = await showRoleSelectionModal();
                const newUserProfile = {
                    email: user.email,
                    displayName: user.displayName,
                    role: role,
                    createdAt: serverTimestamp(),
                    tutorStatus: role === 'tutor' ? 'underReview' : null,
                };
                await setDoc(userRef, newUserProfile);
                userProfile = { id: user.uid, ...newUserProfile };
                showToast(`Welcome! Your account as a ${role} has been created.`, 'success');
            }
            isAuthReady = true;
        };
        
        window.handleSignIn = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showToast('Google Sign-In failed. Please try again.', 'error');
            }
        };

        window.handleSignOut = async () => {
            await signOut(auth);
            showToast('You have been signed out.', 'info');
        };

        // --- Data Fetching and Real-time Listeners ---

        const setupDataListeners = () => {
            if (!userProfile) return;

            // 1. Listen for all verified tutors
            const tutorsQuery = query(collection(db, 'users'), where('role', '==', 'tutor'), where('tutorStatus', '==', 'verified'));
            const unsubTutors = onSnapshot(tutorsQuery, snapshot => {
                allTutors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            });
            activeListeners.push(unsubTutors);

            // 2. Listen for all courses
            const coursesQuery = query(collection(db, 'courses'), orderBy('createdAt', 'desc'));
            const unsubCourses = onSnapshot(coursesQuery, snapshot => {
                allCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            });
            activeListeners.push(unsubCourses);

            // 3. Listen for my subscriptions (student)
            const mySubsQuery = query(collection(db, 'subscriptions'), where('userId', '==', userProfile.id));
            const unsubMySubs = onSnapshot(mySubsQuery, snapshot => {
                mySubscriptions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            });
            activeListeners.push(unsubMySubs);
            
            // 4. Listen for my progress (student)
            const myProgressQuery = query(collection(db, `users/${userProfile.id}/progress`));
            const unsubMyProgress = onSnapshot(myProgressQuery, snapshot => {
                myProgress = snapshot.docs.map(doc => ({ lessonId: doc.id, ...doc.data() }));
                renderApp();
            });
            activeListeners.push(unsubMyProgress);


            // 5. Admin-specific listeners
            if (userProfile.role === 'super_admin' || userProfile.role === 'tutor') {
                const subsQuery = (userProfile.role === 'super_admin')
                    ? query(collection(db, 'subscriptions'), orderBy('subscriptionDate', 'desc'))
                    : query(collection(db, 'subscriptions'), where('tutorId', '==', userProfile.id), orderBy('subscriptionDate', 'desc'));
                
                const unsubAllSubs = onSnapshot(subsQuery, snapshot => {
                    allSubscriptions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderApp();
                });
                activeListeners.push(unsubAllSubs);
            }
             if (userProfile.role === 'super_admin') {
                const allTutorsQuery = query(collection(db, 'users'), where('role', '==', 'tutor'));
                const unsubAllTutors = onSnapshot(allTutorsQuery, snapshot => {
                    allTutors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderApp();
                });
                activeListeners.push(unsubAllTutors);
             }
        };

        const fetchCourseLessons = async (courseId) => {
            const lessonsQuery = query(collection(db, `courses/${courseId}/lessons`), orderBy('order'));
            const snapshot = await getDocs(lessonsQuery);
            currentCourseLessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        };

        // --- UI Rendering Engine ---

        const renderApp = () => {
            const layout = `
                ${(currentUser && userProfile) ? renderNavbar() : ''}
                <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
                    ${renderContentView()}
                </main>
                <footer class="bg-gray-800 text-white text-center p-4">
                    <p>&copy; ${new Date().getFullYear()} Intelligent Learning Platform. All rights reserved.</p>
                </footer>
            `;
            appContainer.innerHTML = layout;
        };

        const renderContentView = () => {
            if (!isAuthReady || currentView === 'loading') return `<div class="text-center p-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-4 text-lg">Loading...</p></div>`;
            
            switch (currentView) {
                case 'login': return renderLoginScreen();
                case 'dashboard': return renderDashboard();
                case 'tutors': return renderTutorsList();
                case 'course':
                    fetchCourseLessons(viewParams.courseId); // Fetch lessons when view is selected
                    return renderCoursePage();
                case 'admin': return renderAdminPanel();
                default: return `<h2>Page not found</h2>`;
            }
        };

        // --- Component Renderers ---
        
        const renderNavbar = () => {
            const isAdmin = userProfile.role === 'tutor' || userProfile.role === 'super_admin';
            return `
                <header class="bg-white shadow-md sticky top-0 z-40">
                    <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
                        <div class="text-2xl font-bold text-indigo-600 cursor-pointer" onclick="navigateTo('dashboard')">ðŸŽ“ Learn Platform</div>
                        <div class="hidden md:flex items-center space-x-6">
                            <a href="#" onclick="navigateTo('dashboard')" class="text-gray-600 hover:text-indigo-600">Dashboard</a>
                            <a href="#" onclick="navigateTo('tutors')" class="text-gray-600 hover:text-indigo-600">Browse Tutors</a>
                            ${isAdmin ? `<a href="#" onclick="navigateTo('admin')" class="text-red-600 font-bold hover:text-red-700">Admin Panel</a>` : ''}
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700 hidden sm:block">Welcome, ${userProfile.displayName}</span>
                            <button onclick="handleSignOut()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Sign Out</button>
                        </div>
                    </nav>
                </header>
            `;
        };

        const renderLoginScreen = () => `
            <div class="flex items-center justify-center min-h-[80vh]">
                <div class="text-center bg-white p-12 rounded-2xl shadow-xl border-t-4 border-indigo-500">
                    <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Welcome to the Learning Platform</h1>
                    <p class="text-gray-600 mb-8">Sign in with Google to begin your learning journey.</p>
                    <button onclick="handleSignIn()" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-600 transition inline-flex items-center space-x-2">
                        <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.7 0 24 0 14.6 0 6.5 4.5 2.7 11.2l7.1 5.5s4.9-3.7 14.2-3.7z"></path><path fill="#4285F4" d="M46.7 24.5c0-1.87-.16-3.71-.48-5.5H24v10.2h12.5c-.53 2.84-2.14 5.38-4.7 7.16l7.13 5.55c4.76-4.2 7.55-10.3 7.55-17.4z"></path><path fill="#FBBC05" d="M10.1 29.5c-.32-1.93-.5-3.95-.5-6s.18-4.07.5-6l-7.1-5.5S.2 14.4 0 23.5s.2 9.1 2.9 11.5l7.2-5.5z"></path><path fill="#34A853" d="M24 48c6.4 0 11.6-2.1 15.4-5.6l-7.1-5.5c-2.4 1.7-5.7 2.8-8.3 2.8-6.3 0-11.8-4.3-13.9-10.1l-7.2 5.5C6.5 43.5 14.6 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        <span>Sign In with Google</span>
                    </button>
                </div>
            </div>
        `;
        
        const renderDashboard = () => {
            const myCoursesHTML = mySubscriptions.map(sub => {
                const course = allCourses.find(c => c.id === sub.courseId);
                if (!course) return '';
                const progressLessons = myProgress.filter(p => p.courseId === course.id);
                const totalLessons = currentCourseLessons.filter(l=>l.courseId === course.id).length || 1; // Avoid division by zero
                const progressPercent = Math.round((progressLessons.length / totalLessons) * 100);

                const statusBadge = {
                    subscribed: `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Subscribed</span>`,
                    underReview: `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Under Review</span>`,
                    canceled: `<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Canceled</span>`
                }[sub.status] || '';

                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform">
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-gray-800">${course.title}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-500 mt-1">by ${course.tutorName}</p>
                            ${sub.status === 'canceled' && sub.reviewerRemark ? `<p class="text-sm text-red-600 mt-2 bg-red-50 p-2 rounded-md">Remark: ${sub.reviewerRemark}</p>` : ''}
                            <div class="mt-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-base font-medium text-indigo-700">Progress</span>
                                    <span class="text-sm font-medium text-indigo-700">${progressPercent}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${progressPercent}%"></div></div>
                            </div>
                            <button onclick="navigateTo('course', { courseId: '${course.id}' })" class="mt-6 bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition w-full">
                                ${sub.status === 'subscribed' ? 'Continue Learning' : 'View Course'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">My Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${mySubscriptions.length > 0 ? myCoursesHTML : `
                        <div class="col-span-full text-center py-12 bg-white rounded-lg shadow-md">
                            <p class="text-gray-500 text-lg">You haven't subscribed to any courses yet.</p>
                            <button onclick="navigateTo('tutors')" class="mt-4 bg-green-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-600 transition">Browse Tutors</button>
                        </div>
                    `}
                </div>
            `;
        };
        
        const renderTutorsList = () => {
             const tutorsHTML = allTutors.map(tutor => {
                const tutorCourses = allCourses.filter(c => c.tutorId === tutor.id);
                return `
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300">
                    <img src="${tutor.imageUrl || `https://ui-avatars.com/api/?name=${tutor.displayName}&background=e0e7ff&color=4f46e5`}" alt="${tutor.displayName}" class="w-24 h-24 rounded-full mb-4 object-cover border-4 border-indigo-200">
                    <h3 class="text-xl font-bold text-gray-800">${tutor.displayName}</h3>
                    <p class="text-gray-500 mt-2 flex-grow">${tutor.bio || 'A passionate educator dedicated to helping students succeed.'}</p>
                     <div class="mt-4">
                        ${tutorCourses.map(c => `<button onclick="navigateTo('course', { courseId: '${c.id}' })" class="inline-block bg-indigo-100 text-indigo-800 text-sm font-semibold px-3 py-1 rounded-full m-1 hover:bg-indigo-200">${c.title}</button>`).join('') || '<p class="text-sm text-gray-400">No courses available yet.</p>'}
                    </div>
                </div>
                `
             }).join('');

             return `
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Our Tutors</h1>
                <p class="text-gray-500 mb-8 text-center">Find the perfect tutor to guide you on your learning path.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${allTutors.length > 0 ? tutorsHTML : '<p class="col-span-full text-center text-gray-500">No verified tutors available at the moment.</p>'}
                </div>
            `;
        }

        const renderCoursePage = () => {
            const course = allCourses.find(c => c.id === viewParams.courseId);
            if (!course) return `<h2>Course not found.</h2>`;
            
            const subscription = mySubscriptions.find(s => s.courseId === course.id);
            const canViewContent = subscription && subscription.status === 'subscribed';
            const isUnderReview = subscription && subscription.status === 'underReview';
            const isCanceled = subscription && subscription.status === 'canceled';
            const isTutorOwner = userProfile.role === 'tutor' && userProfile.id === course.tutorId;
            
            let content;
            if(canViewContent || isTutorOwner) {
                content = renderLessonList();
            } else if (isUnderReview) {
                content = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md" role="alert"><p class="font-bold">Pending Review</p><p>Your subscription request is being reviewed. You will get access once it's approved.</p></div>`;
            } else if (isCanceled) {
                content = renderSubscriptionForm(course, 'canceled');
            } else {
                content = renderSubscriptionForm(course, 'new');
            }

            return `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h1 class="text-4xl font-extrabold text-gray-800">${course.title}</h1>
                    <p class="text-gray-500 mt-2 text-lg">By ${course.tutorName} | Category: ${course.category}</p>
                    <p class="text-gray-700 mt-4">${course.description}</p>
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        ${content}
                    </div>
                </div>
            `;
        };

        const renderLessonList = () => {
            const lessonsHTML = currentCourseLessons.map(lesson => {
                 const isFinished = myProgress.some(p => p.lessonId === lesson.id && p.finished);
                return `
                <details class="group bg-gray-50 rounded-lg mb-3">
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-semibold">
                        <span>Lesson ${lesson.order}: ${lesson.title}</span>
                        <div class="flex items-center space-x-2">
                             ${isFinished ? `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Completed</span>` : ''}
                            <svg class="w-5 h-5 transform transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </summary>
                    <div class="p-6 border-t border-gray-200">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-lg mb-2 text-indigo-700">Video Lesson</h4>
                                <div class="protected-video-wrapper aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-md">
                                    <iframe src="${lesson.youtubeUrl.replace('watch?v=', 'embed/')}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen oncontextmenu="return false;"></iframe>
                                </div>
                            </div>
                             <div>
                                <h4 class="font-bold text-lg mb-2 text-indigo-700">Resources</h4>
                                <div class="space-y-3">
                                    <a href="${lesson.materialsUrl}" target="_blank" class="block bg-blue-100 text-blue-800 p-3 rounded-lg hover:bg-blue-200">Learning Materials</a>
                                    <a href="${lesson.quizUrl}" target="_blank" class="block bg-purple-100 text-purple-800 p-3 rounded-lg hover:bg-purple-200">Take the Quiz</a>
                                </div>
                                <h4 class="font-bold text-lg mt-6 mb-2 text-indigo-700">Tutor Remarks</h4>
                                <p class="text-gray-600 bg-gray-100 p-3 rounded-lg">${lesson.tutorRemarks || 'No remarks for this lesson.'}</p>
                            </div>
                        </div>
                         ${!isFinished ? `<button onclick="window.markLessonAsDone('${lesson.id}', '${viewParams.courseId}')" class="mt-6 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition">Mark as Completed</button>` : ''}
                    </div>
                </details>
                `
            }).join('');
            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Course Lessons</h2>
                ${currentCourseLessons.length > 0 ? lessonsHTML : '<p class="text-gray-500">No lessons have been added to this course yet.</p>'}
            `;
        }

        const renderSubscriptionForm = (course, mode) => {
            const subscription = mySubscriptions.find(s => s.courseId === course.id);
            const remarkHTML = (mode === 'canceled' && subscription?.reviewerRemark) 
                ? `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert"><p class="font-bold">Subscription Canceled</p><p>Reason: ${subscription.reviewerRemark}</p></div>`
                : '';
            
            return `
                <div class="max-w-lg mx-auto bg-gray-50 p-8 rounded-xl shadow-inner border border-gray-200">
                     <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Subscribe to Course</h2>
                     <p class="text-center text-3xl font-bold text-indigo-600 mb-6">$${course.price}</p>
                     ${remarkHTML}
                     <form id="sub-form" onsubmit="event.preventDefault(); window.handleSubscriptionSubmit('${course.id}', '${course.tutorId}', ${course.price})">
                        <div class="space-y-4">
                            <div>
                                <label for="paymentId" class="block text-sm font-medium text-gray-700">Payment Transaction ID</label>
                                <input type="text" name="paymentId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="duration" class="block text-sm font-medium text-gray-700">Subscription Duration</label>
                                <select name="duration" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option>1 Month</option>
                                    <option>3 Months</option>
                                    <option>1 Year</option>
                                </select>
                            </div>
                            <div>
                                <label for="paymentProof" class="block text-sm font-medium text-gray-700">Payment Proof (Image)</label>
                                <input type="file" name="paymentProof" accept="image/*" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            </div>
                        </div>
                        <button type="submit" class="mt-6 w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-700 transition flex items-center justify-center">
                            <span id="sub-btn-text">Submit Request</span>
                            <div id="sub-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </button>
                     </form>
                </div>
            `;
        }

        const renderAdminPanel = () => {
             if (userProfile.role === 'tutor' && userProfile.tutorStatus !== 'verified') {
                 return `<div class="text-center p-12 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">
                    <h2 class="text-2xl font-bold text-yellow-800">Account Under Review</h2>
                    <p class="text-yellow-700 mt-2">Your tutor account is currently being reviewed by the super admin. You will have access to the admin panel once your account is verified.</p>
                 </div>`;
             }

            const adminView = viewParams.adminView || (userProfile.role === 'super_admin' ? 'review_tutors' : 'review_subscriptions');
            
            const renderAdminNav = () => {
                const navItems = [
                    userProfile.role === 'super_admin' && { view: 'review_tutors', label: 'Review Tutors' },
                    { view: 'review_subscriptions', label: 'Review Subscriptions' },
                    userProfile.role !== 'student' && { view: 'manage_courses', label: 'Manage Courses' },
                    { view: 'edit_profile', label: 'Edit Profile' }
                ].filter(Boolean);

                return navItems.map(item => `<button onclick="navigateTo('admin', { adminView: '${item.view}' })" class="${adminView === item.view ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} font-semibold py-2 px-4 rounded-lg transition">${item.label}</button>`).join('');
            };

            const renderAdminContent = () => {
                switch(adminView) {
                    case 'review_tutors': return renderTutorReview();
                    case 'review_subscriptions': return renderSubscriptionReview();
                    case 'manage_courses': return renderCourseManagement();
                    case 'edit_profile': return renderProfileEdit();
                    default: return ``;
                }
            }

            return `
                 <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin Panel</h1>
                 <div class="flex flex-wrap gap-2 mb-8">${renderAdminNav()}</div>
                 <div class="bg-white p-6 rounded-lg shadow-md">${renderAdminContent()}</div>
            `;
        }
        
        // --- Admin Sub-Component Renderers ---
        const renderTutorReview = () => { /* ... Implement UI for super admin to review tutors ... */ return 'Tutor Review Section'; }
        const renderSubscriptionReview = () => { /* ... Implement UI to review subscriptions ... */ return 'Subscription Review Section'; }
        const renderCourseManagement = () => { /* ... Implement UI to add/edit/delete courses and lessons ... */ return 'Course Management Section'; }
        const renderProfileEdit = () => { /* ... Implement UI for tutors to edit their profile ... */ return 'Profile Edit Section'; }
        
        // --- Modals ---
        
        const showRoleSelectionModal = () => {
            return new Promise(resolve => {
                const modalHTML = `
                <div id="role-modal" class="modal-backdrop active">
                    <div class="modal-content text-center">
                        <h2 class="text-2xl font-bold mb-4">Welcome! What is your role?</h2>
                        <p class="text-gray-600 mb-6">Choose your primary role on the platform. If you plan to teach, please select 'Tutor'.</p>
                        <div class="flex justify-center gap-4">
                            <button id="student-btn" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition">Student</button>
                            <button id="tutor-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition">Tutor</button>
                        </div>
                    </div>
                </div>
                `;
                document.getElementById('modal-container').innerHTML = modalHTML;
                
                document.getElementById('student-btn').onclick = () => {
                    document.getElementById('role-modal').remove();
                    resolve('student');
                };
                document.getElementById('tutor-btn').onclick = () => {
                    document.getElementById('role-modal').remove();
                    resolve('tutor');
                };
            });
        };
        
        // --- Global Event Handlers ---
        
        window.handleSubscriptionSubmit = async (courseId, tutorId, price) => {
            const form = document.getElementById('sub-form');
            const button = form.querySelector('button[type="submit"]');
            const btnText = document.getElementById('sub-btn-text');
            const spinner = document.getElementById('sub-spinner');

            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            button.disabled = true;

            const paymentId = form.paymentId.value;
            const duration = form.duration.value;
            const proofFile = form.paymentProof.files[0];

            if (!proofFile) {
                showToast('Please upload a payment proof image.', 'error');
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                button.disabled = false;
                return;
            }
            
            const paymentProofUrl = await uploadToImgBB(proofFile);

            if (paymentProofUrl) {
                const subscriptionData = {
                    userId: userProfile.id,
                    userName: userProfile.displayName,
                    userEmail: userProfile.email,
                    courseId,
                    tutorId,
                    price,
                    paymentId,
                    duration,
                    paymentProofUrl,
                    status: 'underReview',
                    subscriptionDate: serverTimestamp(),
                    reviewerRemark: ''
                };
                await addDoc(collection(db, 'subscriptions'), subscriptionData);
                showToast('Subscription request sent successfully!', 'success');
                navigateTo('dashboard');
            } else {
                 btnText.classList.remove('hidden');
                 spinner.classList.add('hidden');
                 button.disabled = false;
            }
        };

        window.markLessonAsDone = async (lessonId, courseId) => {
            const progressRef = doc(db, `users/${userProfile.id}/progress`, lessonId);
            await setDoc(progressRef, {
                finished: true,
                finishedAt: serverTimestamp(),
                courseId: courseId
            });
            showToast('Lesson marked as completed!', 'success');
        };

        // --- App Initialization ---
        initializeAppAndAuth();

    </script>
</body>
</html>
