<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intelligent Learning Platform — SPA</title>
  <meta name="description" content="Single page learning app — Firebase Auth, Firestore, ImgBB upload, offline & caching friendly" />

  <!-- Tailwind CDN (quick) — replace with build pipeline for production -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root { --brand: #4f46e5; }
    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:#f8fafc}
    /* a few micro-ux helpers */
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,.06);}
    .rounded-2xl{border-radius:1rem}
    /* lightweight protection for videos */
    .no-right-click{user-select:none}
  </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

<!-- App root -->
<div id="app" class="flex-1 container mx-auto p-4 sm:p-6 lg:p-8"></div>

<!-- Modal container -->
<div id="modal-root"></div>

<!-- Helpful template: service worker source (copy to /sw.js in your hosting) -->
<template id="sw-template">
  // ===== sw.js (copy this into a file named /sw.js on your hosting) =====
  const CACHE_NAME = 'ilp-cache-v1';
  const OFFLINE_URL = '/index.html';
  const ASSETS = [
    '/', '/index.html',
    'https://cdn.tailwindcss.com',
    'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap'
  ];

  self.addEventListener('install', (e) => {
    self.skipWaiting();
    e.waitUntil(
      caches.open(CACHE_NAME).then(c => c.addAll(ASSETS.map(u=>new Request(u, {cache: 'reload'}))))
    );
  });

  self.addEventListener('activate', (e) => {
    e.waitUntil(clients.claim());
  });

  self.addEventListener('fetch', (e) => {
    const req = e.request;
    // serve cached first for GET requests, network fallback
    if (req.method !== 'GET') return;
    e.respondWith(
      caches.match(req).then(cached => cached || fetch(req).then(res => {
        // Put a copy in cache (best-effort)
        const copy = res.clone();
        caches.open(CACHE_NAME).then(cache => cache.put(req, copy));
        return res;
      }).catch(()=>caches.match(OFFLINE_URL)))
    );
  });
</template>

<script type="module">
// ------------------
// Single-file SPA logic
// - Firebase modular SDK
// - IndexedDB persistence for Firestore (offline)
// - Local cache + denormalized reads
// - ImgBB upload
// - Lightweight UI with Tailwind
// ------------------

import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
import { getFirestore, enableIndexedDbPersistence, collection, doc, getDoc, setDoc, addDoc, query, where, orderBy, getDocs, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

// ------------------ CONFIG (from user) ------------------
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAjPzI2w1ptxXjfF-nANHTg57zqfznOyVo",
  authDomain: "daring-runway-406008.firebaseapp.com",
  projectId: "daring-runway-406008",
  storageBucket: "daring-runway-406008.appspot.com",
  messagingSenderId: "233176620103",
  appId: "1:233176620103:web:643129a90e6a74f9e8e562",
  measurementId: "G-ERF6KJT723"
};
const IMGBB_API_KEY = '994244fa58d67f7d0f05ed58d03e7962';
const SUPER_ADMIN_EMAIL = 'ahmed.abdelrahmany2018@gmail.com';

// ------------------ APP STATE ------------------
const appRoot = document.getElementById('app');
const modalRoot = document.getElementById('modal-root');
let appState = {
  firebaseApp: null,
  db: null,
  auth: null,
  user: null,
  profile: null,
  tutors: [],
  courses: [],
  subscriptions: [],
  progress: []
};

// ------------------ INIT FIREBASE ------------------
function initFirebase(){
  appState.firebaseApp = initializeApp(FIREBASE_CONFIG);
  appState.auth = getAuth(appState.firebaseApp);
  appState.db = getFirestore(appState.firebaseApp);

  // Try enabling persistence (IndexedDB). If fails (multiple tabs) fallback gracefully.
  enableIndexedDbPersistence(appState.db).catch(err=>{
    console.warn('IndexedDB persistence not enabled:', err && err.message);
  });
}

// ------------------ UTILS ------------------
function el(tag, attrs={}, children=''){ const node = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k.startsWith('on')) node.addEventListener(k.slice(2), v); else node.setAttribute(k,v); }); if(typeof children==='string') node.innerHTML = children; else if(Array.isArray(children)) children.forEach(c=>node.appendChild(typeof c==='string'? document.createTextNode(c) : c)); return node; }

function toast(msg, type='info'){
  const colors = { info: 'bg-indigo-600', success: 'bg-green-600', error: 'bg-red-600' };
  const t = el('div',{class: `fixed right-4 top-6 text-white px-4 py-2 rounded shadow ${colors[type]} z-50`}, msg);
  document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
}

// Save small caches to localStorage to reduce reads (helps stay within free tier)
function saveCache(key, data){ try{ localStorage.setItem(`ilp:${key}`, JSON.stringify({ts:Date.now(),data})); }catch(e){} }
function loadCache(key, maxAgeMs=1000*60*60){ try{ const raw=localStorage.getItem(`ilp:${key}`); if(!raw) return null; const parsed=JSON.parse(raw); if(Date.now()-parsed.ts>maxAgeMs) return null; return parsed.data;}catch(e){return null;} }

// ------------------ ImgBB helper ------------------
async function uploadImgBB(file){
  const fd = new FormData(); fd.append('image', file);
  const url = `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`;
  try{
    const res = await fetch(url, { method: 'POST', body: fd });
    const json = await res.json();
    if(json.success) return json.data.url; else throw new Error(json.error?.message||'Upload failed');
  }catch(e){ console.error(e); return null; }
}

// ------------------ AUTH FLOW ------------------
async function startAuth(){
  const provider = new GoogleAuthProvider();
  try{ await signInWithPopup(appState.auth, provider); }catch(e){ console.error(e); toast('Sign-in failed','error'); }
}

async function signOutUser(){ try{ await signOut(appState.auth); toast('Signed out','info'); }catch(e){console.error(e);} }

// When a new user signs in first time, create profile record with selected role.
function showRoleModal(){
  return new Promise(res=>{
    modalRoot.innerHTML = '';
    const wrap = el('div',{class:'fixed inset-0 flex items-center justify-center bg-black/40 p-4 z-40'});
    const box = el('div',{class:'card p-6 max-w-md w-full text-center'});
    box.innerHTML = `
      <h3 class='text-xl font-bold mb-2'>Choose your role</h3>
      <p class='text-sm text-gray-600 mb-4'>Select whether you'll be a student or a tutor.</p>
      <div class='flex gap-3 justify-center'>
        <button id='role-student' class='px-4 py-2 rounded bg-indigo-600 text-white'>Student</button>
        <button id='role-tutor' class='px-4 py-2 rounded bg-green-600 text-white'>Tutor</button>
      </div>
    `;
    wrap.appendChild(box); modalRoot.appendChild(wrap);
    wrap.querySelector('#role-student').onclick=()=>{ modalRoot.innerHTML=''; res('student'); };
    wrap.querySelector('#role-tutor').onclick=()=>{ modalRoot.innerHTML=''; res('tutor'); };
  });
}

// Fetch or create user profile doc
async function ensureUserProfile(user){
  const uref = doc(appState.db, 'users', user.uid);
  const snap = await getDoc(uref);
  if(snap.exists()){ return { id: snap.id, ...snap.data() } }
  // new user
  const role = await showRoleModal();
  const payload = { email: user.email, displayName: user.displayName||user.email.split('@')[0], role, createdAt: serverTimestamp() };
  if(role==='tutor'){ payload.tutorStatus = 'underReview'; }
  await setDoc(uref, payload);
  return { id: user.uid, ...payload };
}

// ------------------ DATA LISTENERS (real-time where appropriate) ------------------
let unsubscribers = [];
function clearUnsubs(){ unsubscribers.forEach(u=>u()); unsubscribers=[]; }

async function setupRealtime(profile){
  clearUnsubs();
  // Tutors: only show verified tutors — make sure tutors are denormalized on course docs
  const cachedTutors = loadCache('tutors', 1000*60*30);
  if(cachedTutors){ appState.tutors = cachedTutors; render(); }

  const tutorsQ = query(collection(appState.db,'users'), where('role','==','tutor'), where('tutorStatus', '==', 'verified'));
  const unsubTut = onSnapshot(tutorsQ, snap=>{ appState.tutors = snap.docs.map(d=>({ id:d.id, ...d.data() })); saveCache('tutors', appState.tutors); render(); });
  unsubscribers.push(unsubTut);

  // Courses (denormalized: store tutorName & tutorId on course doc to avoid expensive joins)
  const cachedCourses = loadCache('courses', 1000*60*30);
  if(cachedCourses){ appState.courses = cachedCourses; render(); }
  const coursesQ = query(collection(appState.db, 'courses'), orderBy('createdAt','desc'));
  const unsubCourses = onSnapshot(coursesQ, snap=>{ appState.courses = snap.docs.map(d=>({ id:d.id, ...d.data() })); saveCache('courses', appState.courses); render(); });
  unsubscribers.push(unsubCourses);

  // If student, their subscriptions & progress
  if(profile.role==='student'){
    const subsQ = query(collection(appState.db, 'subscriptions'), where('userId','==',profile.id));
    const unsubSubs = onSnapshot(subsQ, snap=>{ appState.subscriptions = snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); }); unsubscribers.push(unsubSubs);

    const progressQ = query(collection(appState.db, `users/${profile.id}/progress`));
    const unsubProg = onSnapshot(progressQ, snap=>{ appState.progress = snap.docs.map(d=>({ lessonId:d.id, ...d.data() })); render(); }); unsubscribers.push(unsubProg);
  }

  // Admins/tutors see subscriptions relevant to them
  if(profile.role==='tutor' || profile.role==='super_admin'){
    const subsQ = profile.role==='super_admin' ? query(collection(appState.db,'subscriptions'), orderBy('subscriptionDate','desc')) : query(collection(appState.db,'subscriptions'), where('tutorId','==',profile.id));
    const unsubAllSubs = onSnapshot(subsQ, snap=>{ /* store but keep lightweight */ appState.allSubscriptions = snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); }); unsubscribers.push(unsubAllSubs);
  }
}

// ------------------ RENDERING (simple router) ------------------
let route = { name: 'loading', params: {} };
function navigateTo(name, params={}){ route = { name, params }; render(); window.scrollTo(0,0); }

function render(){
  // top-level layout
  appRoot.innerHTML = '';
  const header = el('header',{class:'bg-white p-4 rounded-2xl mb-6 flex justify-between items-center'});
  const navLeft = el('div',{}, [ el('div',{class:'text-2xl font-bold text-indigo-600 cursor-pointer', onclick:()=>navigateTo('dashboard')}, '🎓 Learn Platform') ]);
  const navRight = el('div',{class:'flex items-center gap-3'});
  if(appState.user && appState.profile){
    navRight.appendChild(el('div',{class:'text-sm text-gray-700 hidden sm:block'}, `Hi, ${appState.profile.displayName}`));
    navRight.appendChild(el('button',{class:'bg-indigo-600 text-white px-3 py-2 rounded', onclick: signOutUser}, 'Sign Out'));
  } else {
    navRight.appendChild(el('button',{class:'bg-blue-600 text-white px-3 py-2 rounded', onclick: startAuth}, 'Sign in with Google'));
  }
  header.appendChild(navLeft); header.appendChild(navRight);
  appRoot.appendChild(header);

  // content
  const main = el('main',{});
  if(route.name==='loading'){
    main.innerHTML = `<div class='text-center py-24'>Loading…</div>`;
  } else if(route.name==='login'){
    main.innerHTML = `
      <div class='card p-8 max-w-2xl mx-auto text-center'>
        <h1 class='text-3xl font-bold mb-2'>Welcome</h1>
        <p class='text-gray-500 mb-6'>Sign in with Google to continue</p>
        <button class='bg-blue-600 text-white px-5 py-2 rounded' onclick="startAuth()">Sign In</button>
      </div>
    `;
  } else if(route.name==='dashboard'){
    main.appendChild(renderDashboard());
  } else if(route.name==='tutors'){
    main.appendChild(renderTutors());
  } else if(route.name==='course'){
    main.appendChild(renderCoursePage(route.params.courseId));
  } else if(route.name==='admin'){
    main.appendChild(renderAdmin());
  }
  appRoot.appendChild(main);
}

function renderDashboard(){
  const wrap = el('div', {class:'grid grid-cols-1 md:grid-cols-3 gap-6'});
  const left = el('div',{class:'col-span-2'});
  left.appendChild(el('h2',{class:'text-2xl font-bold mb-3'}, 'My Dashboard'));
  // subscriptions quick cards
  const subs = appState.subscriptions || [];
  if(subs.length===0){ left.appendChild(el('div',{class:'card p-6'}, `You haven't subscribed to courses yet. `)); }
  else{
    const grid = el('div',{class:'grid grid-cols-1 gap-4'});
    subs.forEach(s=>{
      const course = appState.courses.find(c=>c.id===s.courseId) || { title: 'Unknown course' };
      grid.appendChild(el('div',{class:'card p-4 flex justify-between items-center'}, [
        el('div',{}, [ el('div',{class:'font-semibold'}, course.title), el('div',{class:'text-sm text-gray-500'}, `Status: ${s.status}`) ]),
        el('div',{}, [ el('button',{class:'bg-indigo-600 text-white px-3 py-1 rounded', onclick:()=>navigateTo('course',{courseId:course.id})}, 'Open') ])
      ]));
    });
    left.appendChild(grid);
  }

  const right = el('div',{});
  right.appendChild(el('div',{class:'card p-4'}, [ el('h3',{class:'font-semibold mb-2'}, 'Browse Tutors'), el('button',{class:'mt-2 bg-green-600 text-white px-3 py-1 rounded', onclick:()=>navigateTo('tutors')}, 'Browse') ]));
  wrap.appendChild(left); wrap.appendChild(right);
  return wrap;
}

function renderTutors(){
  const wrap = el('div', {});
  wrap.appendChild(el('h2',{class:'text-2xl font-bold mb-4'}, 'Tutors'));
  const grid = el('div',{class:'grid grid-cols-1 md:grid-cols-3 gap-6'});
  appState.tutors.forEach(t=>{
    const card = el('div',{class:'card p-6 text-center'}, [
      el('img',{src:t.imageUrl||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.displayName)}&background=e0e7ff&color=4f46e5`, class:'w-24 h-24 rounded-full mx-auto mb-3 object-cover'}),
      el('div',{class:'font-semibold'}, t.displayName),
      el('p',{class:'text-sm text-gray-500 my-2'}, t.bio||'—'),
      el('div',{}, appState.courses.filter(c=>c.tutorId===t.id).slice(0,4).map(c=> el('button',{class:'m-1 px-3 py-1 bg-indigo-100 text-indigo-800 rounded text-sm', onclick:()=>navigateTo('course',{courseId:c.id})}, c.title)))
    ]);
    grid.appendChild(card);
  });
  wrap.appendChild(grid);
  return wrap;
}

async function fetchCourseLessons(courseId){
  // small read: lessons are stored as subcollection; prefer ordering field 'order'
  const lessonsSnap = await getDocs(query(collection(appState.db, `courses/${courseId}/lessons`), orderBy('order')));
  return lessonsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
}

function renderCoursePage(courseId){
  const course = appState.courses.find(c=>c.id===courseId);
  const wrap = el('div',{});
  if(!course) return el('div',{}, 'Course not found');

  const header = el('div',{class:'card p-6 mb-4'}, [ el('h1',{class:'text-2xl font-bold'}, course.title), el('div',{class:'text-sm text-gray-500'}, `By ${course.tutorName||'—'}`), el('p',{class:'mt-3'}, course.description||'') ]);
  wrap.appendChild(header);

  // subscription check
  const mySub = (appState.subscriptions||[]).find(s=>s.courseId===courseId);
  if(!mySub){ // show subscribe form
    const f = el('form',{class:'card p-6 max-w-lg', onsubmit: async (ev)=>{
      ev.preventDefault();
      const paymentId = f.paymentId.value; const duration = f.duration.value; const proof = f.paymentProof.files[0];
      if(!proof){ toast('Upload payment proof','error'); return; }
      const url = await uploadImgBB(proof);
      if(!url){ toast('Upload failed','error'); return; }
      const payload = { userId: appState.profile.id, userName: appState.profile.displayName, userEmail: appState.profile.email, courseId, tutorId: course.tutorId, price: course.price||0, paymentId, duration, paymentProofUrl: url, status:'underReview', subscriptionDate: serverTimestamp(), reviewerRemark: '' };
      await addDoc(collection(appState.db,'subscriptions'), payload);
      toast('Subscription request submitted','success');
      // small optimization: push into local subscriptions to reflect immediate UI
      appState.subscriptions.push({ id:'pending-local', ...payload }); render();
    }});

    f.innerHTML = `
      <h3 class='text-lg font-semibold mb-3'>Subscribe — $${course.price||0}</h3>
      <label class='block text-sm text-gray-600'>Payment Transaction ID<input name='paymentId' required class='mt-1 w-full p-2 border rounded' /></label>
      <label class='block text-sm text-gray-600 mt-3'>Duration<select name='duration' required class='mt-1 w-full p-2 border rounded'><option>1 Month</option><option>3 Months</option><option>1 Year</option></select></label>
      <label class='block text-sm text-gray-600 mt-3'>Payment Proof<input name='paymentProof' type='file' accept='image/*' required class='mt-1 w-full' /></label>
      <button class='mt-4 bg-green-600 text-white px-4 py-2 rounded'>Submit</button>
    `;
    wrap.appendChild(f);
  } else {
    // show lessons (if subscribed or under review show limited view)
    const sCard = el('div',{class:'card p-4 mb-4'}, `Status: ${mySub.status}`);
    wrap.appendChild(sCard);
    // load lessons and show collapsible
    fetchCourseLessons(courseId).then(lessons=>{
      const list = el('div',{});
      lessons.forEach(l=>{
        const det = el('details',{class:'group card p-3 mb-3'}, []);
        det.innerHTML = `<summary class='font-semibold flex justify-between items-center cursor-pointer'>${l.order}. ${l.title} <span class='text-sm text-indigo-600'>Open</span></summary>`;
        const content = el('div',{class:'mt-3'});
        content.innerHTML = `
          <div class='mb-2'>
            <div class='aspect-w-16 aspect-h-9'>
              <iframe src='${(l.youtubeUrl||'').replace('watch?v=','embed/')}' frameborder='0' allowfullscreen class='w-full h-64'></iframe>
            </div>
          </div>
          <a class='block p-2 bg-indigo-50 rounded' href='${l.materialsUrl||'#'}' target='_blank'>Learning materials</a>
          <a class='block p-2 bg-purple-50 rounded mt-2' href='${l.quizUrl||'#'}' target='_blank'>Quiz</a>
          <div class='mt-3'><button class='px-3 py-1 bg-green-600 text-white rounded' onclick="markDone('${l.id}','${courseId}')">Mark as completed</button></div>
        `;
        det.appendChild(content);
        list.appendChild(det);
      });
      wrap.appendChild(list);
    });
  }
  return wrap;
}

function renderAdmin(){
  if(!appState.profile) return el('div',{}, 'No profile');
  if(appState.profile.role==='student') return el('div',{}, 'Admins only');
  return el('div',{}, [ el('h2',{class:'text-xl font-bold mb-2'}, 'Admin Panel — Work in progress') ]);
}

// ------------------ Small helpers used by inline onclicks (exposed) ------------------
window.navigateTo = navigateTo; // small router exposure
window.startAuth = startAuth;
window.markDone = async (lessonId, courseId) => {
  // mark progress doc in subcollection
  const ref = doc(appState.db, `users/${appState.profile.id}/progress`, lessonId);
  await setDoc(ref, { finished: true, finishedAt: serverTimestamp(), courseId });
  toast('Marked finished','success');
}

// ------------------ Listen to auth state ------------------
function wireAuth(){
  onAuthStateChanged(appState.auth, async (user)=>{
    if(!user){ appState.user=null; appState.profile=null; clearUnsubs(); navigateTo('login'); render(); return; }
    appState.user = user;
    // optimistic local profile load to show UI quickly
    const maybe = loadCache(`profile:${user.uid}`, 1000*60*60);
    if(maybe){ appState.profile = maybe; }
    render();
    const profile = await ensureUserProfile(user);
    appState.profile = profile; saveCache(`profile:${user.uid}`, profile);
    // if super admin email -> set role if not present (useful if you seeded manually)
    if(profile.email===SUPER_ADMIN_EMAIL && profile.role!=='super_admin'){ const uref=doc(appState.db,'users',user.uid); await setDoc(uref,{...profile,role:'super_admin'},{merge:true}); profile.role='super_admin'; }
    await setupRealtime(profile);
    navigateTo('dashboard'); render();
  });
}

// ------------------ Service worker registration (optional) ------------------
if('serviceWorker' in navigator){
  // registration is attempted — ensure you copy the sw-template into /sw.js on your host
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registered')).catch(e=>console.warn('SW reg failed - ensure /sw.js exists',e));
}

// ------------------ Boot ------------------
initFirebase(); wireAuth(); navigateTo('loading'); render();

// ------------------ NOTES for deployers (visible in console) ------------------
console.log('APP: ready — small notes:\n- Copy the content of <template id="sw-template"> into /sw.js on your hosting to enable offline caching.\n- For minimizing Firestore reads: denormalize data (store tutorName on course docs), use short-lived local caches (localStorage), and prefer onSnapshot with simple queries.');
</script>

</body>
</html>
